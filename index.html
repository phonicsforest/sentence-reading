<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Read — Lessons, Recording UI, Punctuation, Prev/Redo/Skip/Next</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;overflow:hidden;font-family:system-ui,Arial;background:#fafafa}

  .app{
    height:100vh;width:100vw;
    display:grid;
    grid-template-columns:180px 1fr;
    grid-template-rows:auto auto;
    gap:8px;padding:10px;
  }

  .sidebar{grid-column:1 / 2;grid-row:1 / 3;display:flex;flex-direction:column;min-height:0}
  .lesson-title{font-weight:700;margin-bottom:6px}
  .lesson-list{overflow:auto;flex:1}
  .lesson-item{padding:4px 6px;cursor:pointer;font-size:14px;border-radius:6px}
  .lesson-item:hover{background:#f3f3f3}
  .lesson-item.active{font-weight:700;color:#1976d2}
  .lesson-item.disabled{opacity:.45;cursor:not-allowed}

  .content-row{
    grid-column:2;grid-row:1;
    display:flex;align-items:center;justify-content:center;gap:10px;
  }

  .panel{
    width:900px;height:420px;
    background:#fff;border:2px solid #aaa;border-radius:10px;
    padding:10px;display:flex;flex-direction:row;gap:10px;align-items:center;
  }

  .imgBox{height:100%;aspect-ratio:1/1;overflow:hidden;
    display:flex;align-items:center;justify-content:center;}
  #pixCanvas{width:100%;height:100%;object-fit:cover;image-rendering:pixelated}
  #pageImg{display:none}

  .textCol{flex:1;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:flex-start}
#sentenceWrap{width:100%;height:72%;display:flex;align-items:center;justify-content:center;overflow:hidden}
#translation{width:100%;height:18%;display:flex;align-items:center;justify-content:center;color:#333;font-size:22px;text-align:center;margin-top:4px}
  .punct{color:#666;margin:0 2px}

  .word{margin:0 6px;display:inline-block;color:#aaa;cursor:default;transition:color .2s}
  .word.correct{color:#000}
  .word.skipped{color:#aaa !important}
  .word.special{color:#f88;cursor:pointer}
  .word.special.correct{color:#b00}

  #translation{width:100%;height:22%;display:flex;align-items:center;justify-content:center;color:#333;font-size:22px;text-align:center;margin-top:8px}

  .round-btn{
    width:56px;height:56px;border-radius:50%;border:none;
    background:#e53935;color:#fff;font-size:24px;font-weight:700;
    cursor:pointer;transition:transform .15s;margin:0 4px;
  }
  .round-btn:hover{transform:scale(1.06)}
  .round-btn:disabled{opacity:.4;cursor:not-allowed}

  .link-btn{background:none;border:none;color:#111;cursor:pointer;
    font-size:16px;padding:6px 10px;margin:0 6px;
    display:inline-flex;align-items:center;justify-content:center;
    min-width:46px;height:40px;}
  .link-btn:disabled{opacity:.4;cursor:not-allowed}

  .controls{
    grid-column:2;grid-row:2;
    display:flex;align-items:center;justify-content:center;gap:10px;
    margin-top:-4px;
  }

  .summary{width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:10px;text-align:center}
  .summary h2{margin:6px 0 8px;font-size:28px}
  .summary .line{margin:4px 0;font-size:22px}
  .skipped{color:#c00;font-weight:700}

  .link-btn.rec{ padding:0; width:40px; height:40px; }
  .link-btn.rec .rec-dot{
    width:14px;height:14px;border-radius:50%;background:#e53935;position:relative;
  }
  .link-btn.rec .rec-dot::after{
    content:""; position:absolute; inset:-8px;
    border:4px solid #e53935; border-radius:50%;
    animation:recPulse 1.6s ease-out infinite; opacity:.6;
  }
  @keyframes recPulse{
    0%{ transform:scale(.6); opacity:.6; }
    70%{ transform:scale(1); opacity:.1; }
    100%{ transform:scale(1); opacity:0; }
  }
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="lesson-title">Lessons</div>
    <div id="lessonList" class="lesson-list"></div>
  </aside>

  <div class="content-row">
    <div class="panel" id="panel">
      <div class="imgBox">
        <canvas id="pixCanvas"></canvas>
        <img id="pageImg" alt="">
      </div>
      <div class="textCol">
        <div id="sentenceWrap"><div id="sentence"></div></div>
        <div id="translation"></div>
      </div>
    </div>
  </div>

  <div class="controls">
    <button id="prevBtn" class="round-btn" title="Previous">&lt;</button>
    <button id="startBtn" class="link-btn">Start</button>
    <button id="skipBtn" class="link-btn" disabled>Skip</button>
    <button id="redoBtn" class="link-btn">Redo</button>
    <button id="nextBtn" class="round-btn" title="Next">&gt;</button>
  </div>
</div>

<!-- ✅ 改為從外部 data.js 載入 -->
<script src="data.js"></script>

<script>
if (typeof LESSONS === 'undefined') {
  alert('未載入 data.js！請確認檔案存在並正確連結。');
}

/* ===================== 基本變數 ===================== */
const lessonListEl=document.getElementById('lessonList');
let pixCanvas=document.getElementById('pixCanvas');
let ctx=pixCanvas.getContext('2d',{willReadFrequently:true});
let sentenceDiv=document.getElementById('sentence');
let translationEl=document.getElementById('translation');

const prevBtn=document.getElementById('prevBtn');
const nextBtn=document.getElementById('nextBtn');
const startBtn=document.getElementById('startBtn');
const redoBtn=document.getElementById('redoBtn');
const skipBtn=document.getElementById('skipBtn');

const SPECIAL_WORDS = ["i","do","to","the","a"];

let currentLesson=1;
let pages=LESSONS[currentLesson];
let pageIdx=0;
let words=[],spans=[],wordSpanIdx=[];
let currentIndex=0,correctCount=0;
let recognition=null,isRunning=false,pausedBetween=false,wentBackOnce=false;
const pageStates=[];

function autoFitTwoLines(){
  // 以較大的起始字級開始，視需要再慢慢縮
  let size = 80;
  sentenceDiv.style.fontSize = size + 'px';

const maxH = sentenceWrap.clientHeight * 0.95;  // 略留空間
  // 如高度或寬度超出容器，就每次減 2px，直到仍在兩行內
  while ((sentenceDiv.scrollHeight > maxH || sentenceDiv.clientWidth > sentenceWrap.clientWidth) && size > 26) {
    size -= 2;
    sentenceDiv.style.fontSize = size + 'px';
  }
}
window.addEventListener('resize', autoFitTwoLines);

function resetLessonState(newPages){
  // 清晒上一課的狀態，重新建立乾淨的 pageStates
  pageStates.splice(0, pageStates.length);   // 等同清空陣列
  for (let i = 0; i < newPages.length; i++) {
    pageStates[i] = { correct: new Set(), skipped: new Set(), finished: false };
  }

  // 重置進度變數
  pageIdx = 0;
  currentIndex = 0;
  correctCount = 0;
  pausedBetween = false;
  wentBackOnce = false;
}

const stRaw = pageStates[pageIdx];
const st = stRaw
  ? { correct: new Set(stRaw.correct), skipped: new Set(stRaw.skipped), finished: !!stRaw.finished }
  : { correct: new Set(), skipped: new Set(), finished: false };

/* ===================== 課本清單 ===================== */
function renderLessonList(){
  lessonListEl.innerHTML='';
  for(let i=1;i<=110;i++){
    const item=document.createElement('div');
    item.className='lesson-item';
    if(i===currentLesson)item.classList.add('active');
    if(!LESSONS[i])item.classList.add('disabled');
    item.textContent='Lesson '+i;
item.onclick = () => {
  if(!LESSONS[i]) return alert('Lesson '+i+' 未設定內容');

  // 若剛剛顯示 Finish，要重建 panel
  const panel = document.getElementById('panel');
  if (!panel.querySelector('#sentenceWrap')) {
    panel.innerHTML = `
      <div class="imgBox">
        <canvas id="pixCanvas"></canvas>
        <img id="pageImg" alt="">
      </div>
      <div class="textCol">
        <div id="sentenceWrap"><div id="sentence"></div></div>
        <div id="translation"></div>
      </div>`;
    pixCanvas = document.getElementById('pixCanvas');
    ctx = pixCanvas.getContext('2d',{willReadFrequently:true});
    sentenceDiv = document.getElementById('sentence');
    translationEl = document.getElementById('translation');
    document.querySelector('.controls').style.display = 'flex';
  }

  currentLesson = i;
  pages = LESSONS[i];
  resetLessonState(pages);   // ← 建議一起用這個重置函數
  renderLessonList();
  renderPageFromState();
  updateButtons();
};
    lessonListEl.appendChild(item);
  }
}
renderLessonList();

/* ===================== 畫像素圖 ===================== */
const sourceImg=new Image();
sourceImg.onload=()=>drawPixelate(0);
function drawPixelate(progress){
  const box=pixCanvas.parentElement.getBoundingClientRect();
  const w=sourceImg.width,h=sourceImg.height;if(!w)return;
  const scale=Math.min(box.width/w,box.height/h);
  const drawW=w*scale,drawH=h*scale;
  pixCanvas.width=drawW;pixCanvas.height=drawH;
  const maxCell=40;
  const cell=Math.max(1,Math.round(maxCell*(1-progress)));
  const off=document.createElement('canvas');off.width=Math.ceil(drawW/cell);off.height=Math.ceil(drawH/cell);
  const octx=off.getContext('2d',{willReadFrequently:true});
  octx.imageSmoothingEnabled=false;octx.drawImage(sourceImg,0,0,off.width,off.height);
  ctx.imageSmoothingEnabled=false;ctx.clearRect(0,0,drawW,drawH);
  ctx.drawImage(off,0,0,off.width,off.height,0,0,drawW,drawH);
}
function setProgress(p){drawPixelate(Math.max(0,Math.min(1,p)));}

/* ===================== 渲染頁面 ===================== */
function renderPageFromState(){
  const p=pages[pageIdx];
  if(!p)return;
  sourceImg.src=p.image;
  sentenceDiv.innerHTML='';translationEl.textContent='';
  spans=[];wordSpanIdx=[];
  const tokens=p.text.match(/[A-Za-z']+|[^\s]/g)||[];
  words=tokens.filter(t=>/^[A-Za-z']+$/.test(t));
  const st=pageStates[pageIdx]||{correct:new Set(),skipped:new Set(),finished:false};
  let wordCounter=0;
  tokens.forEach(t=>{
    const sp=document.createElement('span');
    if(/^[A-Za-z']+$/.test(t)){
      sp.textContent=t;sp.className='word';
      const lower=t.toLowerCase();
      if(SPECIAL_WORDS.includes(lower))sp.classList.add('special');
      if(st.correct.has(wordCounter))sp.classList.add('correct');
      if(st.skipped.has(wordCounter))sp.classList.add('skipped');
      sp.addEventListener('click',()=>{if(sp.classList.contains('special'))speakWord(t);});
      wordSpanIdx.push(spans.length);wordCounter++;
    }else{sp.textContent=t;sp.className='punct';}
    sentenceDiv.appendChild(sp);spans.push(sp);
  });
  correctCount=st.correct.size;
  if(st.finished){setProgress(1);translationEl.textContent=p.cn;pausedBetween=true;}
  else{setProgress(correctCount/Math.max(1,words.length));pausedBetween=false;}
  currentIndex=(st.finished)?words.length:Math.min(words.length,(st.correct.size+st.skipped.size));
  autoFitTwoLines();
updateButtons();

}

/* ===================== 儲存狀態 ===================== */
function saveState(finished=false){
  const correct=new Set(),skipped=new Set();
  for(let i=0;i<wordSpanIdx.length;i++){
    const sp=spans[wordSpanIdx[i]];
    if(sp.classList.contains('correct'))correct.add(i);
    if(sp.classList.contains('skipped'))skipped.add(i);
  }
  pageStates[pageIdx]={correct,skipped,finished};
}

/* ===================== 錄音辨識 ===================== */
function containsWholeWord(spoken,variants){
  const tokens=spoken.toLowerCase().split(/\W+/).filter(Boolean);
  const set=new Set(tokens);
  return variants.some(v=>set.has(v.toLowerCase()));
}
function ensureRecognizer(){
  if(recognition)return recognition;
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR)return alert('Browser not supported');
  recognition=new SR();
  recognition.lang='en-GB';
  recognition.continuous=true;
  recognition.onstart=()=>{isRunning=true;showRecordingUI(true);updateButtons();};
  recognition.onend=()=>{if(isRunning){try{recognition.start();}catch(e){}showRecordingUI(true);}else showRecordingUI(false);updateButtons();};
  recognition.onresult=e=>{
    if(!isRunning||pausedBetween)return;
    const said=e.results[e.results.length-1][0].transcript.trim().toLowerCase();
    if(currentIndex>=words.length)return;
    const tgt=words[currentIndex].toLowerCase();
    const variants=(wordVariants[tgt]||[tgt]);
    const ok=containsWholeWord(said,variants);
    if(ok){
      spans[wordSpanIdx[currentIndex]].classList.add('correct');
      currentIndex++;correctCount++;
      setProgress(correctCount/Math.max(1,words.length));
      if(currentIndex>=words.length)finishSentence();
      saveState(false);updateButtons();
    }
  };
  return recognition;
}

/* ===================== 按鈕 ===================== */
startBtn.onclick=async()=>{
  const s=await navigator.mediaDevices.getUserMedia({audio:true}).catch(()=>null);
  if(s)s.getTracks().forEach(t=>t.stop());
  const r=ensureRecognizer();if(!r)return;
  try{r.start();}catch(e){}
};
skipBtn.onclick=()=>{if(!isRunning||pausedBetween)return;
  spans[wordSpanIdx[currentIndex]]?.classList.add('skipped');
  currentIndex++;if(currentIndex>=words.length)finishSentence();
  saveState(false);updateButtons();};
redoBtn.onclick=()=>{wordSpanIdx.forEach(i=>{spans[i].classList.remove('correct','skipped');});
  currentIndex=0;correctCount=0;pausedBetween=false;translationEl.textContent='';setProgress(0);saveState(false);updateButtons();};
prevBtn.onclick=()=>{if(pageIdx>0){saveState(isPageDone());pageIdx--;wentBackOnce=true;renderPageFromState();updateButtons();}};
nextBtn.onclick=()=>{saveState(isPageDone());if(pageIdx<pages.length-1){pageIdx++;renderPageFromState();updateButtons();}else showSummary();};

function finishSentence(){pausedBetween=true;setProgress(1);translationEl.textContent=pages[pageIdx].cn;saveState(true);updateButtons();}
function isPageDone(){const st=pageStates[pageIdx];if(st?.finished)return true;
  const done=(st?.correct?.size||0)+(st?.skipped?.size||0);return done>=words.length&&words.length>0;}
function updateButtons(){
  prevBtn.style.display=(pageIdx>0)?'inline-block':'none';
  redoBtn.style.display=wentBackOnce?'inline-block':'none';
  nextBtn.disabled=!isPageDone();
  skipBtn.disabled=!isRunning||pausedBetween||isPageDone();
  showRecordingUI(isRunning);
}
function showRecordingUI(on){
  if(on){startBtn.classList.add('rec');startBtn.innerHTML='<span class="rec-dot"></span>';}
  else{startBtn.classList.remove('rec');startBtn.textContent='Start';}
}

/* ===================== 完成頁 ===================== */
function showSummary(){
  document.querySelector('.controls').style.display='none';
  const panel=document.getElementById('panel');
  panel.innerHTML='<div class="summary"><h2>Finish</h2></div>';
  const wrap=panel.querySelector('.summary');
  pageStates.forEach((st,idx)=>{
    const line=document.createElement('div');line.className='line';
    const tokens=pages[idx].text.match(/[A-Za-z']+|[^\s]/g)||[];
    let wc=0;
    tokens.forEach(t=>{
      const sp=document.createElement('span');
      sp.textContent=t+' ';
      if(/^[A-Za-z']+$/.test(t)&&st?.skipped?.has(wc))sp.className='skipped';
      if(/^[A-Za-z']+$/.test(t))wc++;
      line.appendChild(sp);
    });
    wrap.appendChild(line);
  });
}
function speakWord(w){const u=new SpeechSynthesisUtterance(w);u.lang='en-GB';speechSynthesis.speak(u);}

/* ===================== 初始化 ===================== */
pages=LESSONS[currentLesson];pageStates.length=pages.length;renderPageFromState();updateButtons();
</script>
</body>
</html>
